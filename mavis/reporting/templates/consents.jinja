{% from "tables/macro.jinja" import table %}
{% from "components/filters.jinja" import filters %}
{% from "components/app_dashboard_card.jinja" import app_dashboard_card %}


{% extends 'layouts/dashboard.jinja' %}

{% block pageTitle %}Consent report | {{ app_title }}{% endblock %}

{% block dashboard_content %}

<div class="nhsuk-grid-row">
  <div class="app-grid-column-filters">
    {{ filters({
      "programmes": programmes,
      "year_groups": year_groups,
      "genders": genders,
      "current_filters": current_filters or {},
      "form_action": url_for('main.consents', workgroup=team.workgroup)
    }) }}
  </div>

  <div id="dashboard" class="app-grid-column-content">

    <div class="nhsuk-card-group nhsuk-grid-row app-card-group">
      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "card_classes": "app-card--blue",
        "heading": "Cohort",
        "description": data.cohort | thousands,
        "caption": "child" if data.cohort == 1 else "children",
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "card_classes": "app-card--red",
        "heading": "No consent",
        "description": data.no_consent_percentage | percentage,
        "caption": data.no_consent | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "card_classes": "app-card--green",
        "heading": "Consent given",
        "description": data.consent_given_percentage | percentage,
        "caption": data.consent_given | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-half",
        "heading": "Consent requested",
        "description": data.consent_requested_percentage | percentage,
        "caption": data.consent_requested | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-half",
        "heading": "No response",
        "description": data.consent_no_response_percentage | percentage,
        "caption": data.consent_no_response | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "heading": "Parent refused",
        "description": data.parent_refused_consent_percentage | percentage,
        "caption": data.parent_refused_consent | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "heading": "Child refused",
        "description": data.child_refused_vaccination_percentage | percentage,
        "caption": data.child_refused_vaccination | format_child_count,
      }) }}

      {{ app_dashboard_card({
        "classes": "nhsuk-grid-column-one-third",
        "heading": "Conflicting consent",
        "description": data.consent_conflicts_percentage | percentage,
        "caption": data.consent_conflicts | format_child_count,
      }) }}
    </div>

    {% set refusal_rows = [] %}
    {% if data.refusal_reasons %}
      {% for reason, count in data.refusal_reasons.items() %}
        {% set _ = refusal_rows.append([
          { "text": reason | humanize },
          { "text": count | thousands, "format": "numeric" }
        ]) %}
      {% endfor %}
    {% else %}
      {% set _ = refusal_rows.append([
        { "text": "No data", "colspan": 2 }
      ]) %}
    {% endif %}

    {{ table({
      "heading": "Reasons for parental refusal",
      "tableClasses": "nhsuk-table--data nhsuk-table--green",
      "panel": true,
      "head": [
        { "text": "Reason"},
        { "text": "Count", "format": "numeric" }
      ],
      "rows": refusal_rows
    }) }}

    {% set consent_rows = [] %}
    {% if data.consent_routes %}
      {% for method, count in data.consent_routes.items() %}
        {% set _ = consent_rows.append([
          { "text": method | humanize },
          { "text": count | thousands, "format": "numeric" }
        ]) %}
      {% endfor %}
    {% else %}
      {% set _ = consent_rows.append([
        { "text": "No data", "colspan": 2 }
      ]) %}
    {% endif %}

    {{ table({
      "heading": "Types of consent",
      "tableClasses": "nhsuk-table--data nhsuk-table--green",
      "panel": true,
      "head": [
        { "text": "Method"},
        { "text": "Count", "format": "numeric" }
      ],
      "rows": consent_rows
    }) }}

    <p class="nhsuk-body-m nhsuk-u-margin-bottom-6">
      This data was last updated on <strong>{{ last_updated_time }}</strong>.
    </p>

  </div>
</div>

{% endblock %}
