{% from "components/heading.jinja" import heading %}
{% from "back-link/macro.jinja" import backLink %}
{% from "radios/macro.jinja" import radios %}
{% from "checkboxes/macro.jinja" import checkboxes %}
{% from "button/macro.jinja" import button %}
{% from "components/form_error_summary.jinja" import formErrorSummary %}

{% extends 'layouts/base.jinja' %}

{% block pageTitle %}{{ organisation.name }} | {{ app_title }}{% endblock %}

{% block beforeContent %}
  {{ backLink({
    "href": url_for("main.start_download", code=organisation.code),
    "text": "Back"
  }) }}
{% endblock %}

{% block before_page_heading %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      {{ formErrorSummary(form) }}
    </div>
  </div>
{% endblock %}

{% block page_heading %}
  {{ heading({
    "text": "Download data",
    "level": "1",
  }) }}
{% endblock %}

{% block page_content %}

<div class="nhsuk-grid-row">
  <div class="nhsuk-u-margin-bottom-3 nhsuk-grid-column-two-thirds">

  <p class="nhsuk-body-m nhsuk-u-margin-bottom-3">
    Download vaccination and consent data for the {{ academic_year }} academic year so far.
  </p>

  <p class="nhsuk-body-m nhsuk-u-margin-bottom-6">
    Last updated: {{ last_updated_time }}.
  </p>

  <form action="{{ url_for('main.download', code=organisation.code) }}" method="post">

    {{ form.csrf_token }}

    {% set items = [] %}
    {% for choice in form.programme.choices %}
      {% set _ = items.append({
        "value": choice[0],
        "text": choice[1],
      }) %}
    {% endfor %}

    {{ radios({
      "idPrefix": form.programme.id,
      "name": form.programme.name,
      "fieldset": {
        "legend": {
          "text": form.programme.label.text,
          "classes": "nhsuk-fieldset__legend--s"
        }
      },
      "errorMessage": {
        "text": form.programme.errors[0],
      } if form.programme.errors else "",
      "items": items,
    }) }}

    {% set items = [] %}
    {% for choice in form.variables.choices %}
      {% set _ = items.append({
        "value": choice[0],
        "text": choice[1],
      }) %}
    {% endfor %}

    {{ checkboxes({
      "idPrefix": form.variables.name,
      "name": form.variables.name,
      "fieldset": {
        "legend": {
          "text": form.variables.label,
          "classes": "nhsuk-fieldset__legend--s"
        }
      },
      "errorMessage": {
        "text": form.variables.errors[0],
      } if form.variables.errors else "",
      "items": items,
    }) }}

    {{ button({
      "text": "Download",
      "type": "submit",
    }) }}

  </form>

  </div>
</div>

{% endblock %}
